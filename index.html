<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>London Route Planner (Open Source)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      #map {
        height: 100vh;
      }
      .leaflet-container {
        height: 100%;
        width: 100%;
        z-index: 1;
      }
      /* Ensure map tiles have proper z-index */
      .leaflet-tile-pane {
        z-index: 1 !important;
      }
      .leaflet-overlay-pane {
        z-index: 2 !important;
      }
      /* Custom scrollbar for route details */
      .route-details-container::-webkit-scrollbar {
        width: 6px;
      }
      .route-details-container::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .route-details-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
      }
      .route-details-container::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .loading-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="flex flex-col md:flex-row h-screen relative">
      <!-- Sidebar Controls -->
      <div class="w-full md:w-96 bg-white shadow-lg p-6 flex flex-col z-20">
        <div class="flex-shrink-0">
          <h1 class="text-2xl font-bold text-gray-800 mb-2">
            London Route Planner
          </h1>
          <p class="text-gray-500 mb-6">
            Find the best routes across the city.
          </p>

          <div class="space-y-4">
            <div>
              <label for="start" class="block text-sm font-medium text-gray-700"
                >Starting Point</label
              >
              <input
                type="text"
                id="start"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder="e.g., SM7 2LJ or Banstead Station"
              />
            </div>
            <div>
              <label for="end" class="block text-sm font-medium text-gray-700"
                >Destination</label
              >
              <input
                type="text"
                id="end"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder="Enter a destination"
              />
            </div>
            <div>
              <label
                for="default-destinations"
                class="block text-sm font-medium text-gray-700"
                >Or Select a Main Station</label
              >
              <select
                id="default-destinations"
                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
              >
                <option value="">Choose a station...</option>
                <option value="London Waterloo Station">London Waterloo</option>
                <option value="London Victoria Station">London Victoria</option>
                <option value="London Bridge Station">London Bridge</option>
                <option value="Liverpool Street Station">
                  Liverpool Street
                </option>
                <option value="King's Cross Station">King's Cross</option>
                <option value="St. Pancras International">
                  St. Pancras International
                </option>
                <option value="Euston Station">Euston</option>
                <option value="Paddington Station">Paddington</option>
              </select>
            </div>
            <button
              id="calculate-route"
              class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out"
            >
              Find Routes
            </button>
          </div>
        </div>

        <!-- Route Details -->
        <div
          id="route-details"
          class="mt-6 flex-grow overflow-y-auto route-details-container pr-2"
        >
          <p class="text-center text-gray-500">
            Your route details will appear here.
          </p>
        </div>
      </div>

      <!-- Map -->
      <div id="map" class="flex-grow z-10"></div>

      <!-- Loading Spinner -->
      <div id="loading-spinner" class="hidden loading-container">
        <div
          class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"
        ></div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // --- IMPORTANT ---
      // Get your free TfL API credentials here: https://api-portal.tfl.gov.uk/
      const TFL_APP_ID = "${{ secrets.TFL_APP_ID }}";
      const TFL_APP_KEY = "${{ secrets.TFL_APP_KEY }}";
      // --- ----------- ---

      let map;
      let routeLayers = [];
      let tileLayer; // Keep reference to tile layer
      let routeGroup; // Layer group for routes
      const routeColors = ["#4F46E5", "#10B981", "#F59E0B", "#EF4444"]; // Indigo, Green, Amber, Red

      // This event listener ensures initMap is called only once when the page loads
      document.addEventListener("DOMContentLoaded", initMap);

      function initMap() {
        map = L.map("map").setView([51.5074, -0.1278], 12); // London center

        // Store reference to tile layer
        tileLayer = L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 19,
            attribution:
              '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          }
        ).addTo(map);

        // Ensure tile layer stays in background
        tileLayer.setZIndex(1);

        // Create layer group for routes
        routeGroup = L.layerGroup().addTo(map);

        document
          .getElementById("calculate-route")
          .addEventListener("click", calculateAndDisplayRoute);
        document
          .getElementById("default-destinations")
          .addEventListener("change", (e) => {
            if (e.target.value) {
              document.getElementById("end").value = e.target.value;
            }
          });
      }

      function showMessage(message, isError = false) {
        const routeDetailsContainer = document.getElementById("route-details");
        const color = isError ? "text-red-500" : "text-gray-500";
        routeDetailsContainer.innerHTML = `<p class="text-center ${color}">${message}</p>`;
      }

      async function getCoords(query) {
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(
          query
        )}&format=json&limit=1&countrycodes=gb`;
        try {
          const response = await fetch(url, {
            headers: { "User-Agent": "LondonRoutePlanner/1.0" },
          });
          const data = await response.json();
          if (data && data.length > 0) {
            return { lat: data[0].lat, lon: data[0].lon };
          }
          return null;
        } catch (error) {
          console.error("Geocoding error:", error);
          return null;
        }
      }

      async function calculateAndDisplayRoute() {
        if (TFL_APP_ID.includes("YOUR_") || TFL_APP_KEY.includes("YOUR_")) {
          showMessage(
            "Please set your TfL API credentials in the index.html file.",
            true
          );
          return;
        }

        const startQuery = document.getElementById("start").value;
        const endQuery = document.getElementById("end").value;

        if (!startQuery || !endQuery) {
          showMessage(
            "Please provide both a starting point and a destination.",
            true
          );
          return;
        }

        document.getElementById("loading-spinner").classList.remove("hidden");
        showMessage("Finding routes...");
        clearDirections();

        try {
          const [startCoords, endCoords] = await Promise.all([
            getCoords(startQuery),
            getCoords(endQuery),
          ]);

          if (!startCoords) {
            throw new Error(`Could not find location for: ${startQuery}`);
          }
          if (!endCoords) {
            throw new Error(`Could not find location for: ${endQuery}`);
          }

          const from = `${startCoords.lat},${startCoords.lon}`;
          const to = `${endCoords.lat},${endCoords.lon}`;

          const tflUrl = `https://api.tfl.gov.uk/Journey/JourneyResults/${from}/to/${to}?app_id=${TFL_APP_ID}&app_key=${TFL_APP_KEY}`;
          const tflResponse = await fetch(tflUrl, {
            method: "GET",
            headers: {
              "Cache-Control": "no-cache",
              Accept: "application/json",
            },
            credentials: "omit",
          });
          const tflData = await tflResponse.json();

          if (tflData.journeys && tflData.journeys.length > 0) {
            displayTflRoutes(tflData);
          } else {
            throw new Error(
              tflData.message ||
                "No journeys found. Try different locations or check their spelling."
            );
          }
        } catch (error) {
          console.error("Routing Error:", error);
          showMessage(error.message, true);
        } finally {
          document.getElementById("loading-spinner").classList.add("hidden");
        }
      }

      function displayTflRoutes({ journeys }) {
        const routeDetailsContainer = document.getElementById("route-details");
        routeDetailsContainer.innerHTML = "";

        // Ensure tile layer is properly maintained
        if (!tileLayer || !map.hasLayer(tileLayer)) {
          // Re-add tile layer if it's missing
          tileLayer = L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            {
              maxZoom: 19,
              attribution:
                '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            }
          );
          map.addLayer(tileLayer);
          tileLayer.setZIndex(1);
        }

        journeys.slice(0, 4).forEach((journey, i) => {
          // Limit to 4 routes
          const color = routeColors[i % routeColors.length];
          const allLatLngs = [];

          journey.legs.forEach((leg) => {
            const decodedPath = decodeLineString(leg.path.lineString);
            const swappedDecodedPath = decodedPath.map((point) => [
              point[1],
              point[0],
            ]);

            allLatLngs.push(...swappedDecodedPath);
          });

          const polyline = L.polyline(allLatLngs, {
            color: color,
            weight: 6,
            opacity: 0.8,
          });

          // Add to route group instead of directly to map
          routeGroup.addLayer(polyline);
          routeLayers.push(polyline);

          const routeCard = createRouteCard(journey, i, color);
          routeDetailsContainer.appendChild(routeCard);

          routeCard.addEventListener("click", () => highlightRoute(i));
        });

        if (routeLayers.length > 0) {
          let firstValidBounds = routeLayers
            .find((layer) => layer.getBounds().isValid())
            ?.getBounds();

          if (firstValidBounds) {
            map.fitBounds(firstValidBounds.pad(0.1));

            // Add a one-time event listener for 'moveend'
            map.once("moveend", () => {
              highlightRoute(0);
            });
          }
          highlightRoute(0);
        }

        // Force map to redraw and ensure tile layer visibility
        setTimeout(() => {
          map.invalidateSize();

          // Ensure tile layer is visible and properly ordered
          if (tileLayer && map.hasLayer(tileLayer)) {
            map.removeLayer(tileLayer);
            map.addLayer(tileLayer);
            tileLayer.setZIndex(1);
            tileLayer.redraw();
          }

          // Bring routes to front but keep tiles visible
          routeLayers.forEach((layer) => {
            layer.bringToFront();
          });
        }, 100);
      }

      function createRouteCard(journey, index, color) {
        const routeCard = document.createElement("div");
        routeCard.className = `p-4 mb-4 border rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow duration-200`;
        routeCard.style.borderColor = color;

        let cardHeader = `
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold" style="color: ${color}">Route ${
          index + 1
        }</h3>
                    <div class="text-right">
                        <p class="font-bold text-lg">${journey.duration} min</p>
                        <p class="text-sm text-gray-500">Arrives ~${new Date(
                          journey.arrivalDateTime
                        ).toLocaleTimeString([], {
                          hour: "2-digit",
                          minute: "2-digit",
                        })}</p>
                    </div>
                </div>`;

        let stepsHtml = '<div class="mt-4 border-t pt-4 space-y-4">';

        journey.legs.forEach((leg) => {
          const icon = getIconForTravelMode(leg.mode.id);
          stepsHtml += `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-6 h-6 mt-1 mr-2">${icon}</div>
                        <div class="flex-grow">
                            <p class="font-medium">${
                              leg.instruction.summary
                            }</p>
                            <p class="text-sm text-gray-500">${
                              leg.duration
                            } min</p>
                            ${
                              leg.mode.id !== "walking"
                                ? `<div class="text-sm text-gray-600 ml-8 mt-1"><p>From: <strong>${leg.departurePoint.commonName}</strong></p><p>To: <strong>${leg.arrivalPoint.commonName}</strong></p></div>`
                                : ""
                            }
                        </div>
                    </div>`;
        });

        stepsHtml += "</div>";
        routeCard.innerHTML = cardHeader + stepsHtml;
        return routeCard;
      }

      function highlightRoute(index) {
        routeLayers.forEach((layer, i) => {
          layer.setStyle({
            weight: 6,
            opacity: 0.6,
          });
        });

        if (routeLayers[index]) {
          routeLayers[index].setStyle({
            weight: 8,
            opacity: 1,
          });
          routeLayers[index].bringToFront();
        }
      }

      function getIconForTravelMode(mode) {
        switch (mode) {
          case "walking":
            return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" /></svg>`;
          case "bus":
            return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;
          case "tube":
          case "dlr":
          case "overground":
          case "tflrail":
          case "elizabeth-line":
            return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>`;
          case "national-rail":
            return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
          default:
            return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`;
        }
      }

      function clearDirections() {
        // Clear the route group
        routeGroup.clearLayers();
        // Reset the array
        routeLayers = [];

        // Ensure tile layer remains visible
        if (tileLayer) {
          if (!map.hasLayer(tileLayer)) {
            map.addLayer(tileLayer);
          }
          tileLayer.setZIndex(1);
          tileLayer.redraw();
        }
      }

      function decodeLineString(lineString) {
        try {
          const lonLatPairs = JSON.parse(lineString);
          // TfL provides [lon, lat], Leaflet needs [lat, lon]
          return lonLatPairs.map((coords) => [coords[1], coords[0]]);
        } catch (e) {
          console.error("Failed to parse lineString:", lineString, e);
          return [];
        }
      }
    </script>
  </body>
</html>
